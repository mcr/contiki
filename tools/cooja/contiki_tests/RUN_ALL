#!/bin/bash

echo ">>>>>>> Cleaning up previous tests <<<<<<<<"
rm -f *.log *.cooja_log
rm -fr se obj_cooja
rm -f symbols.c symbols.h

echo ">>>>>>> Updating from CVS <<<<<<<<"
(cd $CONTIKI && cvs update -dP)

echo ">>>>>>> Building COOJA <<<<<<<<"
(cd $CONTIKI/tools/cooja && ant jar)

echo ">>>>>>> Creating test log <<<<<<<<"
rm -f *.log
LOG="TEST-`date '+%F'`.log"
touch $LOG
echo "" >> $LOG
echo "Starting test run ($LOG)"


for myfile in ./*.csc
do
    TEST=`basename $myfile .csc`
    echo ">>>>>>> Starting test: $TEST <<<<<<<<"

    java -jar ../dist/cooja.jar -nogui -test=$TEST
    if [ -f "COOJA.log" ]; then
      mv COOJA.log $TEST.cooja_log
    fi

    if [ -f "$TEST.log" ]; then
      OK=`grep "TEST OK" $TEST.log | wc -l`
 
      if [ $OK == 0 ]; then
        echo "$TEST: FAIL" >> $LOG
        if [ -f "$TEST.info" ]; then
          echo "--LOG INFO START ($TEST.info) --" >> $LOG
          cat $TEST.info >> $LOG
          echo "--LOG INFO END --" >> $LOG
          echo "" >> $LOG
        else
          echo "-- NO TEST INFO AVAILABLE ($TEST.info) --" >> $LOG
        fi

      else
        echo "$TEST: OK" >> $LOG
      fi

    else
      echo "$TEST: FAIL (no output)" >> $LOG
      if [ -f "$TEST.info" ]; then
        echo "--LOG INFO START ($TEST.info) --" >> $LOG
        cat $TEST.info >> $LOG
        echo "-- TEST INFO END --" >> $LOG
        echo "" >> $LOG
      else
        echo "-- NO TEST INFO AVAILABLE ($TEST.info) --" >> $LOG
      fi
    fi

    echo "" >> $LOG   
done

echo "Sending mail"
cat $LOG | mail -s "Test results (simulation-based)" [email]
